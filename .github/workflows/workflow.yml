on:
    push:
    workflow_dispatch:

defaults:
    run:
        shell: bash

jobs:
    job:
        runs-on: macos-15
        steps:
            - name: Select latest installed Xcode version
              uses: maxim-lobanov/setup-xcode@master
              with:
                xcode-version: latest

            - name: Checkout Build.txt from Xcode mirror
              uses: actions/checkout@main
              with:
                repository: F1248/Xcode-Mirror
                token: ${{ secrets.XCODE_MIRROR_TOKEN }}
                sparse-checkout: Build.txt
                sparse-checkout-cone-mode: false

            - name: Check if latest Xcode version is installed
              run: |
                xcodebuild -version | sed -n "s/Build version //p"
                cat Build.txt
                if [[ "$(xcodebuild -version | sed -n "s/Build version //p")" == "$(cat Build.txt)" ]]; then
                    echo "true"
                    echo "latest_xcode_version_installed=true" >> "$GITHUB_ENV"
                else
                    echo "false"
                    echo "latest_xcode_version_installed=false" >> "$GITHUB_ENV"
                fi

            - name: Checkout Xcode mirror
              if: env.latest_xcode_version_installed == 'false'
              uses: actions/checkout@main
              with:
                repository: F1248/Xcode-Mirror
                token: ${{ secrets.XCODE_MIRROR_TOKEN }}
                sparse-checkout: Xcode.xip-*

            - name: Install unxip
              if: env.latest_xcode_version_installed == 'false'
              run: |
                curl --remote-name --location https://github.com/saagarjha/unxip/releases/latest/download/unxip
                chmod +x unxip

            - name: Install and select Xcode
              if: env.latest_xcode_version_installed == 'false'
              run: |
                ls
                pwd
                cat Xcode.xip-* | ./unxip -
                sudo xcode-select --switch Xcode*.app
                echo "$(xcodebuild -version | tr "\n" " ")installed"
